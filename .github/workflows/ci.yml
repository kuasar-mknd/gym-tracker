name: CI

on:
    push:
        branches: ['main']
        tags: ['v*']
    pull_request:
        branches: ['main']

permissions:
    contents: read

jobs:
    frontend-build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: 'npm'

            - name: Install Node Dependencies
              run: npm install --legacy-peer-deps

            - name: Build Assets
              run: npm run build

            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-assets
                  path: public/build

    laravel-tests:
        runs-on: ubuntu-latest
        needs: frontend-build
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download Build Artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-assets
                  path: public/build

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            - name: Cache Composer dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Install PHP Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: Copy .env
              run: php -r "file_exists('.env') || copy('.env.example', '.env');"

            - name: Generate key
              run: php artisan key:generate

            - name: Directory Permissions
              run: chmod -R 777 storage bootstrap/cache

            - name: Create Database
              run: touch database/database.sqlite

            - name: Execute tests
              env:
                  DB_CONNECTION: sqlite
                  DB_DATABASE: ':memory:'
              run: php artisan test

    browser-tests:
        runs-on: ubuntu-latest
        needs: frontend-build
        services:
            mysql:
                image: mysql:8.4
                env:
                    MYSQL_ALLOW_EMPTY_PASSWORD: yes
                    MYSQL_DATABASE: gym_tracker_dusk
                ports:
                    - 3307:3306
                options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download Build Artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-assets
                  path: public/build

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, mysql, pdo_mysql, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            - name: Cache Composer dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Install PHP Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: Prepare Application
              run: |
                  cp .env.example .env
                  php artisan key:generate
                  chmod -R 777 storage bootstrap/cache

            - name: Install Chrome Driver
              run: php artisan dusk:chrome-driver --detect

            - name: Start Chrome Driver
              run: ./vendor/laravel/dusk/bin/chromedriver-linux --port=9515 &

            - name: Run Dusk Tests
              env:
                  APP_ENV: testing
                  APP_URL: 'http://127.0.0.1:8000'
                  DB_CONNECTION: mysql
                  DB_HOST: 127.0.0.1
                  DB_PORT: 3307
                  DB_DATABASE: gym_tracker_dusk
                  DB_USERNAME: root
                  BROADCAST_CONNECTION: log
                  CACHE_STORE: array
                  SESSION_DRIVER: cookie
                  QUEUE_CONNECTION: sync
                  MAIL_MAILER: array
                  APP_DEBUG: false
                  LOG_LEVEL: debug
                  TELESCOPE_ENABLED: false
                  PULSE_ENABLED: false
                  DUSK_DRIVER_URL: http://127.0.0.1:9515

              run: |
                  # Write environment variables to .env so artisan serve subprocess uses them
                  echo "APP_ENV=testing" >> .env
                  echo "APP_URL=http://127.0.0.1:8000" >> .env
                  echo "DB_CONNECTION=mysql" >> .env
                  echo "DB_HOST=127.0.0.1" >> .env
                  echo "DB_PORT=3307" >> .env
                  echo "DB_DATABASE=gym_tracker_dusk" >> .env
                  echo "DB_USERNAME=root" >> .env
                  echo "DB_PASSWORD=" >> .env
                  echo "SESSION_DRIVER=cookie" >> .env
                  echo "SESSION_DOMAIN=" >> .env
                  echo "SESSION_SECURE_COOKIE=false" >> .env
                  echo "SESSION_SAME_SITE=lax" >> .env
                  echo "SESSION_PATH=/" >> .env
                  echo "BROADCAST_CONNECTION=log" >> .env
                  echo "CACHE_STORE=array" >> .env
                  echo "QUEUE_CONNECTION=sync" >> .env
                  echo "MAIL_MAILER=array" >> .env
                  echo "APP_DEBUG=false" >> .env
                  echo "LOG_LEVEL=debug" >> .env
                  echo "TELESCOPE_ENABLED=false" >> .env
                  echo "PULSE_ENABLED=false" >> .env
                  echo "DUSK_DRIVER_URL=http://127.0.0.1:9515" >> .env
                  php artisan migrate:fresh --seed
                  php artisan serve --host=127.0.0.1 --port=8000 --no-reload &
                  sleep 15
                  php artisan dusk

            - name: Upload Test Screenshots
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: dusk-screenshots
                  path: tests/Browser/screenshots

            - name: Upload Test Logs
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: dusk-logs
                  path: tests/Browser/logs

    lint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            - name: Cache Composer dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Install PHP Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: PHP Lint (Pint)
              run: ./vendor/bin/pint --test

    audit:
        runs-on: ubuntu-latest
        needs: laravel-tests
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            - name: Cache Composer dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Install PHP Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: Composer Audit
              run: composer audit

            - name: PHP Insights
              run: ./vendor/bin/phpinsights analyse --no-interaction --min-quality=90 --min-complexity=90 --min-architecture=90 --min-style=90

            - name: Larastan Analysis
              run: ./vendor/bin/phpstan analyse --memory-limit=2G

            - name: Rector (Dry Run)
              run: ./vendor/bin/rector process --dry-run --no-progress-bar

    build:
        name: Build Image (${{ matrix.platform }})
        runs-on: ${{ matrix.runner }}
        needs: [laravel-tests, browser-tests, lint, audit]
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        strategy:
            matrix:
                include:
                    - runner: ubuntu-latest
                      platform: linux/amd64
                    - runner: ubuntu-24.04-arm64
                      platform: linux/arm64
        permissions:
            contents: read
            packages: write
        env:
            REGISTRY: ghcr.io
            IMAGE_NAME: ${{ github.repository }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

            - name: Build and push by digest
              id: build
              uses: docker/build-push-action@v6
              with:
                  context: .
                  platforms: ${{ matrix.platform }}
                  labels: ${{ steps.meta.outputs.labels }}
                  outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
                  cache-from: type=gha,scope=build-${{ matrix.platform }}
                  cache-to: type=gha,mode=max,scope=build-${{ matrix.platform }}

            - name: Export digest
              run: |
                  mkdir -p /tmp/digests
                  digest="${{ steps.build.outputs.digest }}"
                  touch "/tmp/digests/${digest#sha256:}"

            - name: Upload digest
              uses: actions/upload-artifact@v4
              with:
                  name: digests-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
                  path: /tmp/digests/*
                  if-no-files-found: error
                  retention-days: 1

    merge:
        runs-on: ubuntu-latest
        needs: build
        permissions:
            contents: read
            packages: write
        env:
            REGISTRY: ghcr.io
            IMAGE_NAME: ${{ github.repository }}
        steps:
            - name: Download digests (amd64)
              uses: actions/download-artifact@v4
              with:
                  name: digests-amd64
                  path: /tmp/digests

            - name: Download digests (arm64)
              uses: actions/download-artifact@v4
              with:
                  name: digests-arm64
                  path: /tmp/digests

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=semver,pattern=v{{major}}
                      type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
                      type=sha

            - name: Create manifest list and push
              working-directory: /tmp/digests
              run: |
                  docker buildx imagetools create $(printf '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@sha256:%s ' *) \
                  --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
                  $(echo "${{ steps.meta.outputs.tags }}" | xargs -I {} echo "--tag {}")
