name: CI

on:
    push:
        branches: ['main']
        tags: ['v*']
    pull_request:
        branches: ['main']

permissions:
    contents: read

jobs:
    frontend-build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: 'npm'

            - name: Install Node Dependencies
              run: npm ci --legacy-peer-deps

            - name: Build Assets
              run: npm run build

            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v6
              with:
                  name: build-assets
                  path: public/build

    laravel-tests:
        runs-on: ubuntu-latest
        needs: frontend-build
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Download Build Artifacts
              uses: actions/download-artifact@v7
              with:
                  name: build-assets
                  path: public/build

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            - name: Cache Composer dependencies
              uses: actions/cache@v5
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Install PHP Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: Copy .env
              run: php -r "file_exists('.env') || copy('.env.example', '.env');"

            - name: Generate key
              run: php artisan key:generate

            - name: Directory Permissions
              run: chmod -R 777 storage bootstrap/cache

            - name: Create Database
              run: touch database/database.sqlite

            - name: Execute tests
              env:
                  DB_CONNECTION: sqlite
                  DB_DATABASE: ':memory:'
              run: php artisan test

    browser-tests:
        runs-on: ubuntu-latest
        needs: frontend-build
        services:
            mysql:
                image: mysql:8.4
                env:
                    MYSQL_ALLOW_EMPTY_PASSWORD: yes
                    MYSQL_DATABASE: gym_tracker_dusk
                ports:
                    - 3307:3306
                options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Download Build Artifacts
              uses: actions/download-artifact@v7
              with:
                  name: build-assets
                  path: public/build

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, mysql, pdo_mysql, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            - name: Cache Composer dependencies
              uses: actions/cache@v5
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Install PHP Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: Prepare Application
              run: |
                  cp .env.example .env
                  php artisan key:generate
                  chmod -R 777 storage bootstrap/cache

            - name: Install Chrome Driver
              run: php artisan dusk:chrome-driver --detect

            - name: Start Chrome Driver
              run: ./vendor/laravel/dusk/bin/chromedriver-linux --port=9515 &

            - name: Run Dusk Tests
              env:
                  APP_ENV: testing
                  APP_URL: 'http://127.0.0.1:8000'
                  DB_CONNECTION: mysql
                  DB_HOST: 127.0.0.1
                  DB_PORT: 3307
                  DB_DATABASE: gym_tracker_dusk
                  DB_USERNAME: root
                  BROADCAST_CONNECTION: log
                  CACHE_STORE: array
                  SESSION_DRIVER: database
                  QUEUE_CONNECTION: sync
                  MAIL_MAILER: array
                  APP_DEBUG: false
                  LOG_LEVEL: debug
                  DUSK_DRIVER_URL: http://localhost:9515
                  CSP_ENABLED: false
              run: |
                  # Write environment variables to .env so artisan serve subprocess uses them
                  cat >> .env << 'EOF'
                  APP_ENV=testing
                  APP_URL=http://127.0.0.1:8000
                  DB_CONNECTION=mysql
                  DB_HOST=127.0.0.1
                  DB_PORT=3307
                  DB_DATABASE=gym_tracker_dusk
                  DB_USERNAME=root
                  DB_PASSWORD=
                  SESSION_DRIVER=database
                  SESSION_DOMAIN=
                  SESSION_SECURE_COOKIE=false
                  SESSION_SAME_SITE=lax
                  SESSION_PATH=/
                  BROADCAST_CONNECTION=log
                  CACHE_STORE=array
                  QUEUE_CONNECTION=sync
                  MAIL_MAILER=array
                  APP_DEBUG=false
                  LOG_LEVEL=debug
                  EOF
                  php artisan migrate:fresh --seed
                  php artisan serve --host=127.0.0.1 --port=8000 --no-reload &
                  sleep 15
                  php artisan dusk

            - name: Upload Test Screenshots
              if: failure()
              uses: actions/upload-artifact@v6
              with:
                  name: dusk-screenshots
                  path: tests/Browser/screenshots

            - name: Upload Test Logs
              if: failure()
              uses: actions/upload-artifact@v6
              with:
                  name: dusk-logs
                  path: tests/Browser/logs

    lint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            - name: Cache Composer dependencies
              uses: actions/cache@v5
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Install PHP Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: PHP Lint (Pint)
              run: ./vendor/bin/pint --test

    audit:
        runs-on: ubuntu-latest
        needs: laravel-tests
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            - name: Cache Composer dependencies
              uses: actions/cache@v5
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Install PHP Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: Composer Audit
              run: composer audit

            - name: PHP Insights
              run: php artisan insights --no-interaction --min-quality=90 --min-complexity=90 --min-architecture=90 --min-style=90

            - name: Larastan Analysis
              run: ./vendor/bin/phpstan analyse --memory-limit=2G

            - name: Rector (Dry Run)
              run: ./vendor/bin/rector process --dry-run --no-progress-bar

    deploy:
        name: Build & Push Image
        runs-on: ubuntu-latest
        needs: [laravel-tests, browser-tests, lint, audit]
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        permissions:
            contents: read
            packages: write
        env:
            REGISTRY: ghcr.io
            IMAGE_NAME: ${{ github.repository }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
                      type=sha

            - name: Build and push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  platforms: linux/amd64,linux/arm64
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
