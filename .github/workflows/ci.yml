name: CI

on:
    push:
        branches: ['main']
        tags: ['v*']
    pull_request:
        branches: ['main']

permissions:
    contents: read

jobs:
    setup-php:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Cache Vendor Folder
              id: vendor-cache
              uses: actions/cache@v4
              with:
                  path: vendor
                  key: ${{ runner.os }}-vendor-${{ hashFiles('**/composer.lock') }}

            - name: Install PHP Dependencies
              if: steps.vendor-cache.outputs.cache-hit != 'true'
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    frontend-build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: 'npm'

            - name: Install Node Dependencies
              run: npm install --legacy-peer-deps

            - name: Build Assets
              run: npm run build

            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-assets
                  path: public/build
                  retention-days: 1

    laravel-tests:
        runs-on: ubuntu-latest
        needs: [setup-php, frontend-build]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download Build Artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-assets
                  path: public/build

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Restore Vendor Folder
              uses: actions/cache@v4
              with:
                  path: vendor
                  key: ${{ runner.os }}-vendor-${{ hashFiles('**/composer.lock') }}

            - name: Prepare Application
              run: |
                  cp .env.example .env
                  php artisan key:generate
                  touch database/database.sqlite

            - name: Execute tests
              env:
                  DB_CONNECTION: sqlite
                  DB_DATABASE: ':memory:'
              run: php artisan test --parallel --processes=4

    browser-tests:
        runs-on: ubuntu-latest
        needs: [setup-php, frontend-build]
        services:
            mysql:
                image: mysql:8.4
                env:
                    MYSQL_ALLOW_EMPTY_PASSWORD: yes
                    MYSQL_DATABASE: gym_tracker_dusk
                ports:
                    - 3307:3306
                options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download Build Artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-assets
                  path: public/build

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, mysql, pdo_mysql, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Restore Vendor Folder
              uses: actions/cache@v4
              with:
                  path: vendor
                  key: ${{ runner.os }}-vendor-${{ hashFiles('**/composer.lock') }}

            - name: Install Chrome Driver
              run: php artisan dusk:chrome-driver --detect

            - name: Start Chrome Driver
              run: ./vendor/laravel/dusk/bin/chromedriver-linux --port=9515 &

            - name: Run Dusk Tests
              run: |
                  # Create a fresh .env for Dusk
                  cat <<EOF > .env
                  APP_NAME=GymTracker
                  APP_ENV=testing
                  APP_KEY=base64:$(openssl rand -base64 32)
                  APP_DEBUG=true
                  APP_URL=http://127.0.0.1:8000

                  DB_CONNECTION=mysql
                  DB_HOST=127.0.0.1
                  DB_PORT=3307
                  DB_DATABASE=gym_tracker_dusk
                  DB_USERNAME=root
                  DB_PASSWORD=

                  SESSION_DRIVER=file
                  CACHE_STORE=array
                  QUEUE_CONNECTION=sync
                  MAIL_MAILER=array
                  
                  TELESCOPE_ENABLED=false
                  PULSE_ENABLED=false
                  DUSK_DRIVER_URL=http://127.0.0.1:9515
                  EOF

                  php artisan config:clear
                  php artisan route:clear
                  php artisan view:clear
                  
                  php artisan migrate:fresh --seed --force
                  
                  php artisan serve --host=127.0.0.1 --port=8000 --no-reload &
                  
                  # Wait for server to be ready
                  timeout 30s bash -c 'until curl -s http://127.0.0.1:8000 > /dev/null; do sleep 1; done'
                  
                  php artisan dusk

            - name: Upload Test Screenshots
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: dusk-screenshots
                  path: tests/Browser/screenshots

            - name: Upload Test Logs
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: dusk-logs
                  path: tests/Browser/logs

    lint:
        runs-on: ubuntu-latest
        needs: setup-php
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Restore Vendor Folder
              uses: actions/cache@v4
              with:
                  path: vendor
                  key: ${{ runner.os }}-vendor-${{ hashFiles('**/composer.lock') }}

            - name: PHP Lint (Pint)
              run: ./vendor/bin/pint --test

    audit:
        runs-on: ubuntu-latest
        needs: [setup-php, laravel-tests]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, readline
                  coverage: none
                  tools: composer:v2

            - name: Restore Vendor Folder
              uses: actions/cache@v4
              with:
                  path: vendor
                  key: ${{ runner.os }}-vendor-${{ hashFiles('**/composer.lock') }}

            - name: Composer Audit
              run: composer audit

            - name: PHP Insights
              run: ./vendor/bin/phpinsights analyse --no-interaction --min-quality=90 --min-complexity=90 --min-architecture=90 --min-style=90

            - name: Larastan Analysis
              run: ./vendor/bin/phpstan analyse --memory-limit=2G

            - name: Rector (Dry Run)
              run: ./vendor/bin/rector process --dry-run --no-progress-bar

    build:
        name: Build Image (${{ matrix.platform }})
        runs-on: ${{ matrix.runner }}
        needs: [laravel-tests, browser-tests, lint, audit]
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        strategy:
            matrix:
                include:
                    - runner: ubuntu-latest
                      platform: linux/amd64
                    - runner: ubuntu-24.04-arm
                      platform: linux/arm64
        permissions:
            contents: read
            packages: write
        env:
            REGISTRY: ghcr.io
            IMAGE_NAME: ${{ github.repository }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

            - name: Build and push by digest
              id: build
              uses: docker/build-push-action@v6
              with:
                  context: .
                  platforms: ${{ matrix.platform }}
                  labels: ${{ steps.meta.outputs.labels }}
                  outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
                  cache-from: type=gha,scope=build-${{ matrix.platform }}
                  cache-to: type=gha,mode=max,scope=build-${{ matrix.platform }}

            - name: Export digest
              run: |
                  mkdir -p /tmp/digests
                  digest="${{ steps.build.outputs.digest }}"
                  touch "/tmp/digests/${digest#sha256:}"

            - name: Upload digest
              uses: actions/upload-artifact@v4
              with:
                  name: digests-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
                  path: /tmp/digests/*
                  if-no-files-found: error
                  retention-days: 1

    merge:
        runs-on: ubuntu-latest
        needs: build
        permissions:
            contents: read
            packages: write
        env:
            REGISTRY: ghcr.io
            IMAGE_NAME: ${{ github.repository }}
        steps:
            - name: Download digests (amd64)
              uses: actions/download-artifact@v4
              with:
                  name: digests-amd64
                  path: /tmp/digests

            - name: Download digests (arm64)
              uses: actions/download-artifact@v4
              with:
                  name: digests-arm64
                  path: /tmp/digests

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=semver,pattern=v{{major}}
                      type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
                      type=sha

            - name: Create manifest list and push
              working-directory: /tmp/digests
              run: |
                  docker buildx imagetools create $(printf '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@sha256:%s ' *) \
                  --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
                  $(echo "${{ steps.meta.outputs.tags }}" | xargs -I {} echo "--tag {}")
